{% extends "base.html" %}

{% block css %}
<!-- <link href="{{ url_for('static', filename='static/css/sweetalert2.min.css') }}" rel="stylesheet"> -->

<!-- <link href="{{ url_for('static', filename='static/css/jquery.dataTables.min.css') }}" rel="stylesheet"> -->
<style>
	.disabled-link {
		pointer-events: none;
		cursor: default;
		/* å¯é€‰ï¼šæ›´æ”¹é¼ æ ‡æ ·å¼ */
		color: gray;
		/* å¯é€‰ï¼šæ”¹å˜é¢œè‰²ï¼Œä½¿å…¶çœ‹èµ·æ¥è¢«ç¦ç”¨ */
	}
</style>
{% endblock %}


{% block content %}
<div class="container-fluid">
	<div class="row">
		<div class="col-xl-12">
			<div class="d-flex mb-1 justify-content-between align-items-center flex-wrap">
				<form id="data-search" class="table-search d-flex gap-2">
					<div class="input-group search-area mb-xxl-0 mb-2">
						<input type="text" name="username" class="form-control" placeholder="ç”¨æˆ·å">
					</div>
					<div class="input-group search-area mb-xxl-0 mb-2">
						<input type="text" name="email" class="form-control" placeholder="é‚®ç®±">
					</div>
					<div class="input-group search-area mb-xxl-0 mb-2">
						<input type="text" name="phone" class="form-control" placeholder="æ‰‹æœº">
					</div>
					<div class="input-group search-area mb-xxl-0 mb-2">
						<select class="default-select form-control wide" name="status">
							<option value="">é€‰æ‹©ç±»åˆ«</option>
							<option value="1">æ­£å¸¸</option>
							<option value="0">å¼‚å¸¸</option>
						</select>
					</div>
					<button type="submit" class="btn btn-sm btn-primary flex-shrink-0">æœç´¢</button>
				</form>
			</div>
			<div class="tab-content">
				<div class="tab-pane active show">
					<div class="table-responsive">
						<table class="table card-table default-table display mb-4 dataTablesCard table-responsive-xl "
							id="guestTable-all">
							<thead>
								<tr>
									<th class="bg-none">
										<div class="form-check style-1">
											<input class="form-check-input" type="checkbox" value="" id="checkAll">
										</div>
									</th>
									<th>ç¼–å·/ç”¨æˆ·å</th>
									<th>é‚®ç®±</th>
									<th>æ‰‹æœº</th>
									<th>çŠ¶æ€</th>
									<th>æ³¨å†Œæ—¶é—´</th>
									<th>æ“ä½œ</th>
								</tr>
							</thead>
							<tbody id="data-table">

							</tbody>
						</table>
						<ul class="pagination pagination-circle" id="data-pages">
							<li class="page-item page-indicator">
								<a class="page-link" href="javascript:void(0)">
									<i class="la la-angle-left"></i></a>
							</li>
							<li class="page-item active"><a class="page-link" href="javascript:void(0)">1</a>
							</li>
							<li class="page-item"><a class="page-link" href="javascript:void(0)">2</a></li>
							<li class="page-item"><a class="page-link" href="javascript:void(0)">3</a></li>
							<li class="page-item"><a class="page-link" href="javascript:void(0)">4</a></li>
							<li class="page-item page-indicator">
								<a class="page-link" href="javascript:void(0)">
									<i class="la la-angle-right"></i></a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block js %}
<!-- Required vendors -->
<script src="{{ url_for('static', filename='static/js/global.min.js') }}"></script>
<script src="{{ url_for('static', filename='static/js/jquery.nice-select.min.js') }}"></script>

<!-- Datatable -->
<!-- <script src="{{ url_for('static', filename='static/js/jquery.dataTables.min.js') }}"></script> -->
<!-- <script src="{{ url_for('static', filename='static/js/datatables.init.js') }}"></script> -->
<!-- <script src="{{ url_for('static', filename='static/js/sweetalert2.min.js') }}"></script>
<script src="{{ url_for('static', filename='static/js/sweetalert.init.js') }}"></script> -->
<script src="{{ url_for('static', filename='static/js/sweetalert2@11.js') }}"></script>
<script src="{{ url_for('static', filename='static/js/custom.min.js') }}"></script>
<script src="{{ url_for('static', filename='static/js/deznav-init.js') }}"></script>
<script src="{{ url_for('static', filename='static/js/demo.js') }}"></script>
<script src="{{ url_for('static', filename='static/js/styleSwitcher.js') }}"></script>
<script>

	let search = "";
	let this_page = 1;
	function renderPages(page = this_page, filters = "") {
		$.ajax({
			url: "/user/?page=" + page + "&" + filters,
		}).done(function (res) {
			let data = res.data;
			let tr = "";
			let pre_page = data.page - 1;
			let next_page = data.page + 1;
			let pre_disabled = "";
			let next_disabled = "";
			if (data.page == 1) {
				pre_page = 1;
				pre_disabled = "disabled-link";
			}
			if (next_page > data.max_page) {
				next_page = data.max_page;
				next_disabled = "disabled-link";
			}

			let pages = `<li class="page-item page-indicator ${pre_disabled}">
							<a class="page-link" href="javascript:void(0)" data-index="${pre_page}">
								<i class="la la-angle-left"></i></a>
						</li>`;
			for (let i = 0; i < data.items.length; i++) {
				tr += `<tr>
						<td>
							<div class="form-check style-1">
								<input class="form-check-input" type="checkbox" value="">
							</div>
						</td>
						<td>
							<div class="media-bx">
								<img class="me-3 rounded"
									src="${data.items[i].avatar}" alt="">
								<div>
									<span class="text-primary">#` + data.items[i].id + `</span>
									<h4 class="mb-0 mt-1"><a class="text-black"
											href="guest-detail.html">` + data.items[i].username + `</a></h4>
								</div>
							</div>
						</td>
						<td>
							<div>
								<h5>` + data.items[i].email + `</h5>
							</div>
						</td>
						<td>
							<div>
								<h5>` + data.items[i].phone + `</h5>
							</div>
						</td>
						<td>
							<div>
								<h5>` + data.items[i].status_text + `</h5>
							</div>
						</td>
						<td><h5>` + data.items[i].created_at + `</h5></td>
						<td>
							<div class="dropdown dropstart">
								<a href="javascript:void(0);" class="btn-link" data-bs-toggle="dropdown"
									aria-expanded="false">
									<svg width="24" height="24" viewbox="0 0 24 24" fill="none"
										xmlns="http://www.w3.org/2000/svg">
										<path
											d="M11 12C11 12.5523 11.4477 13 12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12Z"
											stroke="#262626" stroke-width="2" stroke-linecap="round"
											stroke-linejoin="round">
										</path>
										<path
											d="M18 12C18 12.5523 18.4477 13 19 13C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11C18.4477 11 18 11.4477 18 12Z"
											stroke="#262626" stroke-width="2" stroke-linecap="round"
											stroke-linejoin="round">
										</path>
										<path
											d="M4 12C4 12.5523 4.44772 13 5 13C5.55228 13 6 12.5523 6 12C6 11.4477 5.55228 11 5 11C4.44772 11 4 11.4477 4 12Z"
											stroke="#262626" stroke-width="2" stroke-linecap="round"
											stroke-linejoin="round">
										</path>
									</svg>
								</a>
								<div class="dropdown-menu">
									<a class="dropdown-item edit" data-index="${data.items[i].id}" href="javascript:void(0);">ç¼–è¾‘</a>
									<a class="dropdown-item delete" data-index="${data.items[i].id}" href="javascript:void(0);">åˆ é™¤</a>
								</div>
							</div>
						</td>
					</tr>`;
				// console.log(data.items[i])
			}
			for (let i = 0; i < data.pages.length; i++) {
				let active = "";
				let disabled = "";
				if (data.pages[i] == data.page) {
					active = "active";
				}
				if (data.pages[i] == "...") {
					disabled = "disabled-link";
				}
				pages += `<li class="page-item ${active} ${disabled}"><a class="page-link" href="javascript:void(0)" data-index="${data.pages[i]}">${data.pages[i]}</a></li>`;
			}

			pages += `<li class="page-item page-indicator ${next_disabled}">
						<a class="page-link" href="javascript:void(0)" data-index="${next_page}">
							<i class="la la-angle-right"></i></a>
					</li>`;
			$("#data-table").html(tr);
			$("#data-pages").html(pages);
		});
	}

	renderPages();
	$("#data-pages").on("click", ".page-link", function (event) {
		this_page = $(this).data("index");
		renderPages(this_page, search);
	})

	$("#data-table").on("click", ".delete", function (event) {
		let id = $(this).data("index");
		Swal.fire({
			title: "ç¡®å®šåˆ é™¤å—ï¼Ÿ",
			text: "åˆ é™¤åä¸å¯æ’¤é”€ï¼",
			icon: "warning",
			showCancelButton: true,
			confirmButtonColor: "#3085d6",
			cancelButtonColor: "#d33",
			confirmButtonText: "ç¡®å®š",
			cancelButtonText: "å–æ¶ˆ",
		}).then((result) => {
			if (result.isConfirmed) {
				$.ajax({
					url: "/user/" + id,
					type: "DELETE"
				}).done(function (res) {
					Swal.fire({
						// title: "Deleted!",
						text: res.msg,
						icon: "success"
					});
					renderPages(this_page, search);
				})
			}
		});
	});

	$("#data-table").on("click", ".edit", function (event) {
		let id = $(this).data("index");
		Swal.fire({
			title: "ç¼–è¾‘ç”¨æˆ·",
			width: 800,
			html: `
    <iframe src="http://127.0.0.1:5000/user/edit.html?id=${id}" width="100%" height="400px" style="border: none;"></iframe>
  `,
			showCloseButton: true,
			showConfirmButton: false,
			allowOutsideClick: false, // ğŸš« ç¦æ­¢ç‚¹å‡»å¼¹çª—å¤–å…³é—­
		}).then((result) => {
			// âš¡ åˆ¤æ–­ç”¨æˆ·æ˜¯å¦‚ä½•å…³é—­å¼¹çª—çš„
			if (result.isDismissed && result.dismiss === Swal.DismissReason.close) {
				renderPages(this_page, search);
			}
		});;

	});

	$("#data-search").on("submit", function (e) {
		e.preventDefault();

		// serialize() å°†è¡¨å•åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
		search = $(this).serialize();
		this_page = 1;
		renderPages(this_page, search);
	});
</script>
{% endblock %}